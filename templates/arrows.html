<html>
<head>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script>
/*Python script shall return on AJAX request, a complete drawarrow function, and shall then run drawcanvas funciton*/
phasors = {};
window.onload = function() {
   scale = 1;
   canvas = document.getElementById("c");
   ctx = canvas.getContext("2d");
   ctx.translate(300, 300);
   drawcanvas();
   drag = false;
   var dragStart;
   var dragEnd;
   
   canvas.addEventListener('mousedown', function(event) {
    dragStart = {
      x: event.pageX - canvas.offsetLeft,
      y: event.pageY - canvas.offsetTop
    }
    drag = true;
  })
  
  canvas.addEventListener('mouseup', function(event) {
    drag = false;
  })

  canvas.addEventListener('mousemove', function(event) {
    if (drag) {
      dragEnd = {
        x: event.pageX - canvas.offsetLeft,
        y: event.pageY - canvas.offsetTop
      }
      ctx.translate(dragEnd.x - dragStart.x, dragEnd.y - dragStart.y);
	  dragStart = dragEnd;
      clearcanvas()
      drawcanvas()
    }
	
  })
} 

window.onresize = function() {
    canvas.innerHeight = canvas.innerWidth;
}

function drawcanvas() {
  //Draw background
  ctx.fillStyle = "#f2f2f2";
  ctx.fillRect(-1e10/ctx.getTransform()['a'], -1e10/ctx.getTransform()['a'], 2*1e10/ctx.getTransform()['a'], 2*1e10/ctx.getTransform()['a']);
  
  //Draws axes
  ctx.beginPath();
  ctx.strokeStyle = 'black'; 
  canvas_arrow(ctx, 0, 0, 1e10/ctx.getTransform()['a'], 0);
  canvas_arrow(ctx, 0, 0, -1e10/ctx.getTransform()['a'], 0);
  canvas_arrow(ctx, 0, 0, 0, 1e10/ctx.getTransform()['a']);
  canvas_arrow(ctx, 0, 0, 0, -1e10/ctx.getTransform()['a']);
  ctx.stroke();
  
  //Draw phasors
  ctx.lineWidth = 1.2/ctx.getTransform()['a'];
  ctx.strokeStyle = 'red'; //allow user to change this.
  ctx.beginPath();
  drawarrow(ctx);
  ctx.stroke();
   
}

function drawarrow(ctx) {
  //canvas_arrow(ctx, 0, 0, 290, -290);
  for (var i = 0; i < Object.keys(phasors).length; i++) {
		canvas_arrow(ctx, 0, 0, phasors[i][1], -phasors[i][2])
  }
}


function clearcanvas() {
  let current_transform = ctx.getTransform();
  ctx.setTransform(1.1, 0, 0, 1.1, 0, 0);
  ctx.clearRect(0, 0, canvas.width*scale, canvas.height*scale);
  ctx.setTransform(current_transform);
}

function zoomin() {
  clearcanvas();
  scale = 1.1;
  ctx.scale(scale, scale);
  drawcanvas();
}

function zoomout() {
  clearcanvas();
  scale = 1.0/1.1;
  ctx.scale(scale, scale);
  drawcanvas();
}

function canvas_arrow(context, fromx, fromy, tox, toy) {
  var headlen = 10; // length of head in pixels
  var dx = tox - fromx;
  var dy = toy - fromy;
  var angle = Math.atan2(dy, dx);
  context.moveTo(fromx, fromy);
  context.lineTo(tox, toy);
  context.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));
  context.moveTo(tox, toy);
  context.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));
}

function processreq() {
    /*
    var name = document.getElementById("name");
    var message = document.getElementById("message");

    var entry = {
      name: name.value,
      message: message.value
    };*/
    fetch('/reqprocess', {
      method: "POST",
      credentials: "include",
      //body: JSON.stringify(no),
	  body: "",
      cache: "no-cache",
      headers: new Headers({
        "content-type": "application/json"
      })
    })
      .then(function (response) {
        if (response.status !== 200) {
          console.log(`Looks like there was a problem. Status code: ${response.status}`);
          return;
        }
        response.json().then(function (data) {
		    keys = Object.keys(data);
            for (var i = 0; i < keys.length; i++) {
			    phasors[i] = [data[i].name, data[i].x, data[i].y];
			}
            drawcanvas();			
        });
      })
      .catch(function (error) {
        console.log("Fetch error: " + error);
      });
}
</script>
</head>

<body>
  <canvas id="c" class="h-75" height=600px width=600px style="border: solid 1px blue; padding-top=100%"></canvas><br />
  <button onclick="zoomin()" class="btn btn-dark">+</button>
  <button onclick="zoomout()" class="btn btn-dark">-</button>
  <span id="stat"></span>
</body>
